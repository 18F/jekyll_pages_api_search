#! /usr/bin/env ruby
# Author: Mike Bland <michael.bland@gsa.gov>
# Date:   2015-06-21

require_relative '../lib/jekyll_pages_api_search'
require 'fileutils'
require 'jekyll_pages_api'
require 'zlib'

JPAS = ::JekyllPagesApiSearch
ASSETS_DIR = JPAS::JavascriptCopier::ASSETS_DIR

USAGE=<<END_USAGE
#{$0}: generate a lunr.js index from Jekyll Pages API output

Usage:
  #{$0} basedir config.yml pages.json
    uses an existing pages.json to build the index
  #{$0} basedir config.yml pages.json baseurl title_prefix body_element_tag
    produces pages.json and pages.json.gz in addition to the index
  #{$0} -h

The resulting index will be saved in basedir/search-index.json. A gzipped
version will be produced as well. The JavaScript bundle containing the search
integration code will be stored in basedir/#{ASSETS_DIR}.

Arguments:
  -h
    Print this help message
  basedir
    Path to the generated site's root directory
  config.yml
    Path to the site's config.yml containing a `jekyll_pages_api_search` entry
  pages.json
    Path to the output file generated by `jekyll_pages_api`
  baseurl
    URL prefix of every page of the generated site
  title_prefix
    Prefix to strip from page titles
  body_element_tag
    Tag (or tag prefix) identifying the main content element within the <body>
    element of each document. Can be a complete tag (ending in '>'), or the
    prefix of a longer tag. Used to strip boilerplate out of the content
    exported via the API.
END_USAGE

if ARGV.length == 1 && ARGV[0] == '-h'
  puts USAGE
  exit
end

unless ARGV.length == 3 || ARGV.length == 6
  $stderr.puts "Wrong number of arguments: #{ARGV.length}"
  $stderr.puts USAGE
  exit 1
end

basedir, config, pages_json, baseurl, title_prefix, body_element_tag = ARGV

unless File.exist? basedir
  $stderr.puts "#{basedir} does not exist"
  exit 1
end

if ARGV.length == 3 && !File.exist?(pages_json)
  $stderr.puts "#{pages_json} does not exist"
  exit 1
end

site = JPAS::Site.new basedir, config

if baseurl.nil?
  site.load_pages_json pages_json
else
  site.pages << ::JekyllPagesApi::Generator.new(
    ::JekyllPagesApi::GeneratedSite.new(
      baseurl, basedir, title_prefix, body_element_tag)).page
end

index = JPAS::SearchIndexBuilder.build_index site
index_outfile = File.join site.source, index.name
output = { index_outfile => index.output.to_s }
output[pages_json] = site.pages.first.output unless File.exist? pages_json
output.each do |outfile, content|
  File.open(outfile, 'w') {|f| f << content}
  JPAS::Compressor::gzip_in_memory_content outfile => content
end

target_path = File.join site.source, ASSETS_DIR
FileUtils.mkdir_p target_path
JPAS::JavascriptCopier::search_bundle_paths {|f| FileUtils.cp f, target_path}
